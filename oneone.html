<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Math Quiz (1-Digit, Vertical)</title>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: system-ui, -apple-system, Arial, sans-serif;
      background: #0b0f1a;
      color: #fff;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    .app {
      min-height: 100vh;
      max-width: 520px;
      margin: 0 auto;
      padding: 16px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .topbar {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .backBtn{
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.10);
      color: #fff;
      font-weight: 900;
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
    }
    .backBtn:active { transform: scale(0.98); }

    .pill {
      flex: 1;
      text-align: center;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      font-weight: 800;
      font-size: 13px;
    }

    .card {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 16px;
      padding: 16px;
    }

    .question {
      margin: 0;
      font-weight: 900;
      letter-spacing: 0.2px;
    }

    .vertMath {
      display: inline-block;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-weight: 900;
      font-size: 32px;
      line-height: 1.12;
      text-align: right;
      min-width: 4ch;
      user-select: none;
    }

    .vertMath .r { display: flex; justify-content: flex-end; gap: 0.6ch; }
    .vertMath .op { width: 1ch; text-align: center; }
    .vertMath .line { border-top: 3px solid rgba(255,255,255,0.85); margin: 6px 0 4px; }
    .vertMath .ans { text-align: right; }

    .hint {
      margin: 10px 0 0;
      color: rgba(255,255,255,0.75);
      font-size: 14px;
    }

    .timerWrap {
      margin-top: 12px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 999px;
      overflow: hidden;
      height: 10px;
    }
    .timerBar {
      height: 100%;
      width: 100%;
      background: rgba(255,255,255,0.55);
      transform-origin: left center;
      transform: scaleX(1);
    }

    .choices {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 14px;
    }

    .choiceBtn {
      width: 100%;
      padding: 16px;
      border-radius: 16px;
      border: 2px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.05);
      color: #fff;
      font-weight: 900;
      font-size: 18px;
      cursor: pointer;
    }
    .choiceBtn:disabled { opacity: 0.95; cursor: default; }

    .correct { border-color: #22c55e !important; }
    .wrong { border-color: #ef4444 !important; }

    .restart {
      width: 100%;
      margin-top: 14px;
      padding: 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.10);
      color: #fff;
      font-weight: 900;
      cursor: pointer;
    }

    .footer {
      margin-top: auto;
      text-align: center;
      color: rgba(255,255,255,0.6);
      font-size: 12px;
    }
  </style>
</head>

<body>
  <div class="app">

    <!-- TOP BAR -->
    <div class="topbar">
      <button class="backBtn" id="backBtn">← Back</button>
      <div class="pill" id="roundPill">Round 1 / 10</div>
      <div class="pill" id="scorePill">Score: 0</div>
    </div>

    <div class="card">
      <div class="question" id="questionText">Loading…</div>
      <p class="hint" id="hintText">Tap an answer (10 seconds).</p>

      <div class="timerWrap">
        <div class="timerBar" id="timerBar"></div>
      </div>

      <div class="choices" id="choicesArea"></div>
      <button class="restart" id="restartBtn" style="display:none;">Restart</button>
    </div>

    <div class="footer">
      Leaderboard is global (Firestore)
    </div>
  </div>

  <script type="module">
    // =========================
    // BACK BUTTON (same behavior)
    // =========================
    document.getElementById("backBtn").addEventListener("click", () => {
      window.location.href = "https://akmu2014.github.io/Speed/";
    });

    // =========================
    // SETTINGS (UPDATED)
    // =========================
    const NUM_ROUNDS = 10;      // 10 total
    const ADD_COUNT  = 5;       // 5 additions
    const SUB_COUNT  = 5;       // 5 subtractions

    const TIME_LIMIT_MS = 10000; // 10 seconds
    const FEEDBACK_MS   = 650;
    const TICK_MS       = 40;

    // One-digit only
    const ADD_A_MIN = 0, ADD_A_MAX = 9;
    const ADD_B_MIN = 0, ADD_B_MAX = 9;

    // Keep subtraction non-negative (a >= b)
    const SUB_A_MIN = 0, SUB_A_MAX = 9;
    const SUB_B_MIN = 0, SUB_B_MAX = 9;

    // =========================
    // STATE
    // =========================
    let quiz = [];
    let idx = 0;
    let score = 0;

    let roundStart = 0;
    let timerInterval = null;
    let timeoutHandle = null;
    let locked = false;

    // =========================
    // ELEMENTS
    // =========================
    const roundPill = document.getElementById("roundPill");
    const scorePill = document.getElementById("scorePill");
    const questionText = document.getElementById("questionText");
    const hintText = document.getElementById("hintText");
    const choicesArea = document.getElementById("choicesArea");
    const restartBtn = document.getElementById("restartBtn");
    const timerBar = document.getElementById("timerBar");

    // =========================
    // UTIL
    // =========================
    function randInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function shuffleInPlace(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function clearTimers() {
      if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
      if (timeoutHandle) { clearTimeout(timeoutHandle); timeoutHandle = null; }
    }

    function disableAllChoices() {
      choicesArea.querySelectorAll("button").forEach(b => b.disabled = true);
    }

    function highlightCorrect(correctVal) {
      choicesArea.querySelectorAll("button").forEach(b => {
        if (Number(b.textContent) === correctVal) b.classList.add("correct");
      });
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function setPills() {
      roundPill.textContent = `Round ${Math.min(idx + 1, quiz.length)} / ${quiz.length}`;
      scorePill.textContent = `Score: ${score}`;
    }

    function renderVerticalMath(item) {
      const a = String(item.a);
      const b = String(item.b);
      const w = Math.max(a.length, b.length);
      const aPad = a.padStart(w, " ");
      const bPad = b.padStart(w, " ");
      const toNbsp = (s) => escapeHtml(s).replaceAll(" ", "&nbsp;");

      return `
        <div class="vertMath" aria-label="${escapeHtml(item.a)} ${escapeHtml(item.op)} ${escapeHtml(item.b)} equals what">
          <div class="r"><span>${toNbsp(aPad)}</span></div>
          <div class="r"><span class="op">${escapeHtml(item.op)}</span><span>${toNbsp(bPad)}</span></div>
          <div class="line"></div>
          <div class="ans">?</div>
        </div>
      `;
    }

    // =========================
    // DISTRACTORS (simple for 1-digit)
    // =========================
    function buildDistractors(correct) {
      const set = new Set();
      while (set.size < 3) {
        let cand = randInt(0, 18); // max sum is 18; keeps choices reasonable
        if (cand !== correct) set.add(cand);
      }
      return Array.from(set);
    }

    // =========================
    // QUESTION GENERATORS (1-digit)
    // =========================
    function makeAddition(usedKeys) {
      let a, b, key;
      do {
        a = randInt(ADD_A_MIN, ADD_A_MAX);
        b = randInt(ADD_B_MIN, ADD_B_MAX);
        key = `A:${a}+${b}`;
      } while (usedKeys.has(key));
      usedKeys.add(key);

      const correct = a + b;
      const choices = shuffleInPlace([correct, ...buildDistractors(correct)]);
      return { op: "+", a, b, correct, choices };
    }

    function makeSubtraction(usedKeys) {
      let a, b, key;
      do {
        a = randInt(SUB_A_MIN, SUB_A_MAX);
        b = randInt(SUB_B_MIN, SUB_B_MAX);
        // force non-negative
        if (b > a) [a, b] = [b, a];
        key = `S:${a}-${b}`;
      } while (usedKeys.has(key));
      usedKeys.add(key);

      const correct = a - b;
      // for subtraction, keep distractors in 0..9
      const set = new Set();
      while (set.size < 3) {
        const cand = randInt(0, 9);
        if (cand !== correct) set.add(cand);
      }
      const choices = shuffleInPlace([correct, ...Array.from(set)]);
      return { op: "−", a, b, correct, choices };
    }

    function buildNewQuiz() {
      const usedKeys = new Set();
      const q = [];

      for (let i = 0; i < ADD_COUNT; i++) q.push(makeAddition(usedKeys));
      for (let i = 0; i < SUB_COUNT; i++) q.push(makeSubtraction(usedKeys));

      shuffleInPlace(q);
      q.forEach(item => shuffleInPlace(item.choices));
      return q;
    }

    // =========================
    // TIMER
    // =========================
    function startTimer() {
      clearTimers();
      locked = false;

      roundStart = performance.now();
      timerBar.style.transform = "scaleX(1)";

      timerInterval = setInterval(() => {
        const elapsed = performance.now() - roundStart;
        const remaining = Math.max(0, TIME_LIMIT_MS - elapsed);
        timerBar.style.transform = `scaleX(${remaining / TIME_LIMIT_MS})`;
        if (remaining <= 0) timerBar.style.transform = "scaleX(0)";
      }, TICK_MS);

      timeoutHandle = setTimeout(() => {
        if (locked) return;
        locked = true;

        disableAllChoices();
        const item = quiz[idx];
        hintText.textContent = `Time’s up ❌ (Answer: ${item.correct})`;
        highlightCorrect(item.correct);

        clearTimers();
        setTimeout(nextRound, FEEDBACK_MS);
      }, TIME_LIMIT_MS);
    }

    // =========================
    // GAME FLOW
    // =========================
    function renderQuestion() {
      setPills();
      restartBtn.style.display = "none";

      const item = quiz[idx];
      questionText.innerHTML = renderVerticalMath(item);
      hintText.textContent = "Tap an answer (10 seconds).";

      choicesArea.innerHTML = "";
      item.choices.forEach((value) => {
        const btn = document.createElement("button");
        btn.className = "choiceBtn";
        btn.textContent = value;
        btn.addEventListener("click", () => handleAnswer(btn, value));
        choicesArea.appendChild(btn);
      });

      startTimer();
    }

    function handleAnswer(clickedBtn, value) {
      if (locked) return;
      locked = true;

      clearTimers();
      disableAllChoices();

      const item = quiz[idx];
      const isCorrect = value === item.correct;

      if (isCorrect) {
        score += 1;
        clickedBtn.classList.add("correct");
        hintText.textContent = "Correct ✅";
      } else {
        clickedBtn.classList.add("wrong");
        hintText.textContent = `Wrong ❌ (Answer: ${item.correct})`;
        highlightCorrect(item.correct);
      }

      scorePill.textContent = `Score: ${score}`;
      timerBar.style.transform = "scaleX(0)";

      setTimeout(nextRound, FEEDBACK_MS);
    }

    function nextRound() {
      idx += 1;
      if (idx >= quiz.length) renderResult();
      else renderQuestion();
    }

    function renderResult() {
      clearTimers();
      locked = true;

      const total = quiz.length;
      const pct = Math.round((score / total) * 100);

      roundPill.textContent = "Finished";
      scorePill.textContent = `Score: ${score}`;
      questionText.innerHTML = `<div class="vertMath" style="min-width:auto;">${escapeHtml(pct + "% (" + score + "/" + total + ")")}</div>`;
      hintText.textContent = "Tap Restart for a new set.";

      choicesArea.innerHTML = "";
      timerBar.style.transform = "scaleX(0)";
      restartBtn.style.display = "block";
    }

    function startNewRun() {
      clearTimers();
      quiz = buildNewQuiz();
      idx = 0;
      score = 0;
      locked = false;

      renderQuestion();
    }

    restartBtn.addEventListener("click", startNewRun);

    // Start
    startNewRun();
  </script>
</body>
</html>
